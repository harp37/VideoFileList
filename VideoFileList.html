<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Video Library Manager</title>
  
  <style>
    /* Arc-inspired base styles with green theme */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      background-color: #f9fafb;
      color: #1a1a1a;
      line-height: 1.5;
      padding: 40px 20px;
      min-height: 100vh;
    }

    .app-container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .app-header {
      text-align: center;
      margin-bottom: 48px;
    }

    h1 {
      color: #1a1a1a;
      font-size: 32px;
      font-weight: 400;
      letter-spacing: -0.5px;
      margin-bottom: 8px;
    }

    .app-subtitle {
      color: #4b5563;
      font-size: 16px;
      font-weight: 400;
    }

    .control-card {
      background: #ffffff;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
      border: 1px solid #e5e7eb;
    }

    .file-input-section {
      margin-bottom: 24px;
    }

    .section-title {
      font-size: 14px;
      font-weight: 500;
      color: #374151;
      margin-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .file-inputs {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 16px;
    }

    .custom-file-input {
      position: relative;
      display: inline-block;
    }

    .custom-file-input input[type="file"] {
      position: absolute;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }

    .custom-file-input label {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 15px;
      font-weight: 500;
      border: 1px solid transparent;
    }

    .file-button label {
      background-color: #059669;
      color: white;
    }

    .file-button:hover label {
      background-color: #047857;
    }

    .folder-button label {
      background-color: #10b981;
      color: white;
    }

    .folder-button:hover label {
      background-color: #059669;
    }

    .status-actions {
      display: flex;
      align-items: center;
      gap: 16px;
      flex-wrap: wrap;
    }

    .file-count {
      color: #6b7280;
      font-size: 15px;
    }

    .btn {
      padding: 10px 20px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-size: 15px;
      font-weight: 500;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background-color: #059669;
      color: white;
    }

    .btn-primary:hover {
      background-color: #047857;
    }

    .btn-primary:disabled {
      background-color: #e5e7eb;
      color: #9ca3af;
      cursor: not-allowed;
    }

    .btn-secondary {
      background-color: #f3f4f6;
      color: #374151;
      border: 1px solid #d1d5db;
    }

    .btn-secondary:hover {
      background-color: #e5e7eb;
    }

    .options-section {
      border-top: 1px solid #e5e7eb;
      padding-top: 24px;
    }

    .options-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
    }

    .option-toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      user-select: none;
    }

    .option-toggle input[type="checkbox"] {
      width: 20px;
      height: 20px;
      accent-color: #059669;
      cursor: pointer;
    }

    .option-toggle label {
      font-size: 15px;
      color: #1a1a1a;
      cursor: pointer;
    }

    .file-list-container {
      background: #ffffff;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
      border: 1px solid #e5e7eb;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 15px;
    }

    thead {
      background-color: #f9fafb;
      border-bottom: 1px solid #e5e7eb;
    }

    th {
      padding: 16px 20px;
      text-align: left;
      font-weight: 500;
      color: #374151;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    td {
      padding: 16px 20px;
      border-bottom: 1px solid #f3f4f6;
    }

    tr:last-child td {
      border-bottom: none;
    }

    tr:nth-child(even) {
      background-color: #f9fafb;
    }

    tr:hover {
      background-color: #f0fdf4;
    }

    /* Make video rows clickable */
    tbody tr {
      cursor: pointer;
      transition: all 0.2s ease;
    }

    tbody tr:not(.folder-header):hover {
      background-color: #f0fdf4 !important;
      transform: translateY(-1px);
    }

    .folder-header {
      background-color: #059669 !important;
      color: white !important;
      cursor: default !important;
    }

    .folder-header:hover {
      background-color: #047857 !important;
      transform: none !important;
    }

    .folder-header td {
      font-weight: 500;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    /* Selected row styling */
    tbody tr.selected:not(.folder-header) {
      background-color: #d1fae5 !important;
      position: relative;
    }

    tbody tr.selected:not(.folder-header)::after {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 4px;
      background-color: #059669;
    }

    /* Video preview styles */
    .video-preview-container {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 320px;
      height: 200px;
      background: #ffffff;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
      border: 1px solid #e5e7eb;
      overflow: hidden;
      transform: scale(0.8) translateY(20px);
      opacity: 0;
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      z-index: 1000;
    }

    .video-preview-container.visible {
      transform: scale(1) translateY(0);
      opacity: 1;
    }

    .video-preview-header {
      background: #f9fafb;
      padding: 8px 12px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .video-preview-title {
      font-size: 14px;
      font-weight: 500;
      color: #374151;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 250px;
    }

    .video-preview-close {
      background: none;
      border: none;
      color: #6b7280;
      cursor: pointer;
      padding: 4px;
      font-size: 16px;
      transition: color 0.2s ease;
      line-height: 1;
    }

    .video-preview-close:hover {
      color: #374151;
    }

    .video-preview-content {
      height: calc(100% - 41px);
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    .video-preview-video {
      width: 100%;
      height: 100%;
      object-fit: contain;
      background: #000;
    }

    .video-preview-loading,
    .video-preview-error {
      text-align: center;
      color: #6b7280;
      font-size: 14px;
      padding: 20px;
    }

    .video-preview-error {
      color: #ef4444;
    }

    .export-section {
      margin-top: 24px;
      text-align: center;
    }

    .export-grid {
      display: flex;
      gap: 12px;
      justify-content: center;
      flex-wrap: wrap;
      margin-top: 16px;
    }

    .export-button {
      background-color: #f3f4f6;
      color: #374151;
      border: 1px solid #d1d5db;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .export-button:hover {
      background-color: #e5e7eb;
      border-color: #9ca3af;
    }

    .loading {
      text-align: center;
      padding: 40px 20px;
      color: #6b7280;
      font-style: italic;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #6b7280;
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 12px;
      opacity: 0.5;
    }

    .empty-state-text {
      font-size: 16px;
      line-height: 1.6;
    }

    .decorative-accent {
      position: relative;
    }

    .decorative-accent::after {
      content: '';
      position: absolute;
      bottom: -2px;
      left: 0;
      width: 60px;
      height: 2px;
      background: linear-gradient(90deg, #059669 0%, transparent 100%);
    }

    @media (max-width: 768px) {
      body {
        padding: 20px 16px;
      }

      .app-header {
        margin-bottom: 32px;
      }

      h1 {
        font-size: 28px;
      }

      .control-card {
        padding: 20px;
      }

      .file-inputs {
        flex-direction: column;
      }

      .options-grid {
        grid-template-columns: 1fr;
      }

      table {
        font-size: 14px;
      }

      th, td {
        padding: 12px 16px;
      }

      /* Adjust video preview for mobile */
      .video-preview-container {
        width: calc(100% - 40px);
        height: 180px;
        left: 20px;
        right: 20px;
      }
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(8px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .file-list-container {
      animation: fadeIn 0.3s ease-out;
    }

    .btn-primary:focus {
      box-shadow: 0 0 0 3px rgba(5, 150, 105, 0.1);
    }

    .custom-file-input label:focus-within {
      box-shadow: 0 0 0 3px rgba(5, 150, 105, 0.1);
    }
  </style>
</head>

<body>
  <div class="app-container">
    <header class="app-header">
      <h1 class="decorative-accent">Video Library Manager</h1>
      <p class="app-subtitle">Organize and analyze your video files with elegance</p>
    </header>

    <div class="control-card">
      <div class="file-input-section">
        <h2 class="section-title">Select Content</h2>
        <div class="file-inputs">
          <div class="custom-file-input file-button">
            <input type="file" id="fileInput" multiple accept="video/*">
            <label for="fileInput">
              <span>📁</span>
              Select Files
            </label>
          </div>
          <div class="custom-file-input folder-button">
            <input type="file" id="folderInput" webkitdirectory directory accept="video/*">
            <label for="folderInput">
              <span>📂</span>
              Select Folders
            </label>
          </div>
        </div>
        
        <div class="status-actions">
          <span class="file-count" id="fileCount">No content selected</span>
          <button class="btn btn-secondary" id="clearButton" onclick="clearSelection()">
            <span>↻</span>
            Clear Selection
          </button>
          <button class="btn btn-primary" id="generateButton" onclick="handleGenerateList()" disabled>
            <span>⚡</span>
            Generate List
          </button>
        </div>
      </div>
      
      <div class="options-section">
        <h2 class="section-title">Formatting Options</h2>
        <div class="options-grid">
          <label class="option-toggle">
            <input type="checkbox" id="disableExtensionsCheckbox" onchange="toggleDisableExtensions()">
            <span>Hide File Extensions</span>
          </label>
          <label class="option-toggle">
            <input type="checkbox" id="disableResolutionsCheckbox" onchange="toggleDisableResolutions()">
            <span>Hide Resolutions</span>
          </label>
          <label class="option-toggle">
            <input type="checkbox" id="replaceDotsCheckbox" onchange="toggleReplaceDots()">
            <span>Replace Dots with Spaces</span>
          </label>
          <label class="option-toggle">
            <input type="checkbox" id="curtailLongTitlesCheckbox" onchange="toggleCurtailLongTitles()">
            <span>Limit Long Titles</span>
          </label>
        </div>
      </div>
    </div>

    <div id="fileList"></div>
  </div>

  <!-- Video preview container -->
  <div id="videoPreview" class="video-preview-container">
    <div class="video-preview-header">
      <div class="video-preview-title" id="previewTitle">Video Preview</div>
      <button class="video-preview-close" onclick="closeVideoPreview()">×</button>
    </div>
    <div class="video-preview-content" id="previewContent">
      <div class="video-preview-loading">Loading video...</div>
    </div>
  </div>

  <script>
    // Global variables
    let fileList = [];
    let folderStructure = {};
    let disableResolutions = false;
    let disableExtensions = false;
    let replaceDots = false;
    let curtailLongTitles = false;
    let currentPreviewFile = null;
    let currentSelectedRow = null;

    // Initialize when the document is loaded
    document.addEventListener('DOMContentLoaded', function() {
      // Add event listeners for file and folder inputs
      const fileInput = document.getElementById('fileInput');
      const folderInput = document.getElementById('folderInput');
      
      fileInput.addEventListener('change', handleFileSelection);
      folderInput.addEventListener('change', handleFolderSelection);
      
      // Show empty state initially
      showEmptyState();
      
      // Update UI for initial state
      updateFileCount();
    });

    // Show empty state message
    function showEmptyState() {
      const fileListDiv = document.getElementById('fileList');
      fileListDiv.innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon">🎬</div>
          <div class="empty-state-text">Select video files or folders to get started.<br>Your organized file list will appear here.<br><br>Click any video in the list to preview it.</div>
        </div>
      `;
    }

    // Handle file selection
    function handleFileSelection() {
      const fileInput = document.getElementById('fileInput');
      
      // Add selected files to fileList (not organized by folder)
      if (fileInput.files.length > 0) {
        const files = Array.from(fileInput.files);
        files.forEach(file => {
          // Add files without folder context
          if (!folderStructure['Individual Files']) {
            folderStructure['Individual Files'] = [];
          }
          folderStructure['Individual Files'].push(file);
        });
        
        updateFileCount();
        // Clear empty state once files are selected
        if (Object.keys(folderStructure).length > 0) {
          document.getElementById('fileList').innerHTML = '';
        }
      }
    }

    // Handle folder selection
    function handleFolderSelection() {
      const folderInput = document.getElementById('folderInput');
      
      if (folderInput.files.length > 0) {
        // Organize files by their relative folder path
        const files = Array.from(folderInput.files);
        
        files.forEach(file => {
          // Get the folder path relative to the selected directory
          let relativePath = file.webkitRelativePath || file.relativePath || '';
          let folderPath = relativePath.substring(0, relativePath.lastIndexOf('/')) || 'Root';
          
          // Create folder entry if it doesn't exist
          if (!folderStructure[folderPath]) {
            folderStructure[folderPath] = [];
          }
          
          // Add file to the appropriate folder
          folderStructure[folderPath].push(file);
        });
        
        updateFileCount();
        // Clear empty state once files are selected
        if (Object.keys(folderStructure).length > 0) {
          document.getElementById('fileList').innerHTML = '';
        }
      }
    }

    // Clear all selections
    function clearSelection() {
      const fileInput = document.getElementById('fileInput');
      const folderInput = document.getElementById('folderInput');
      
      fileInput.value = '';
      folderInput.value = '';
      fileList = [];
      folderStructure = {};
      
      // Close video preview if open
      closeVideoPreview();
      
      // Show empty state
      showEmptyState();
      
      updateFileCount();
    }

    // Update file count display and generate button status
    function updateFileCount() {
      const fileCountElement = document.getElementById('fileCount');
      const generateButton = document.getElementById('generateButton');
      
      // Count total files across all folders
      let totalFiles = 0;
      let totalFolders = Object.keys(folderStructure).length;
      
      Object.values(folderStructure).forEach(files => {
        totalFiles += files.length;
      });
      
      if (totalFiles === 0) {
        fileCountElement.textContent = 'No content selected';
        generateButton.disabled = true;
      } else {
        let countText = `${totalFiles} file${totalFiles === 1 ? '' : 's'}`;
        if (totalFolders > 0) {
          countText += ` from ${totalFolders} source${totalFolders === 1 ? '' : 's'}`;
        }
        fileCountElement.textContent = countText;
        generateButton.disabled = false;
      }
    }

    // Handle generate list button click
    function handleGenerateList() {
      // Create fileList from folderStructure
      fileList = [];
      Object.values(folderStructure).forEach(files => {
        fileList = fileList.concat(files);
      });
      
      if (fileList.length === 0) {
        alert('Please select one or more files or folders.');
        return;
      }

      const fileListDiv = document.getElementById('fileList');
      fileListDiv.innerHTML = '<div class="loading">Processing files, please wait...</div>';
      
      // Use setTimeout to allow the "processing" message to display
      setTimeout(() => {
        createFileList();
      }, 10);
    }

    // Create the file list table
    function createFileList() {
      const fileListDiv = document.getElementById('fileList');
      fileListDiv.innerHTML = ''; // Clear previous file list

      // Create container for the table
      const container = document.createElement('div');
      container.className = 'file-list-container';
      
      const table = document.createElement('table');
      const tableHead = document.createElement('thead');
      const tableBody = document.createElement('tbody');
      const headerRow = document.createElement('tr');

      const headers = ['File Name', 'Runtime', 'Bitrate (Mbps)', 'Date Modified'];
      headers.forEach(headerText => {
        const headerCell = document.createElement('th');
        headerCell.textContent = headerText;
        headerRow.appendChild(headerCell);
      });

      tableHead.appendChild(headerRow);
      table.appendChild(tableHead);
      table.appendChild(tableBody);
      container.appendChild(table);
      fileListDiv.appendChild(container);

      let processedCount = 0;
      let totalFiles = 0;
      
      // Count total files for progress tracking
      Object.values(folderStructure).forEach(files => {
        totalFiles += files.length;
      });
      
      // Add a loading indicator row
      const loadingRow = document.createElement('tr');
      const loadingCell = document.createElement('td');
      loadingCell.colSpan = 4;
      loadingCell.textContent = 'Processing video metadata...';
      loadingCell.style.textAlign = 'center';
      loadingCell.style.fontStyle = 'italic';
      loadingCell.style.color = '#6b7280';
      loadingRow.appendChild(loadingCell);
      tableBody.appendChild(loadingRow);

      // Process files by folder
      Object.entries(folderStructure).forEach(([folderPath, files]) => {
        // Add folder header row if we have multiple folders
        if (Object.keys(folderStructure).length > 1) {
          const folderRow = document.createElement('tr');
          folderRow.className = 'folder-header';
          const folderCell = document.createElement('td');
          folderCell.colSpan = 4;
          folderCell.textContent = `📁 ${folderPath} (${files.length} files)`;
          folderRow.appendChild(folderCell);
          tableBody.appendChild(folderRow);
        }

        // Process files in this folder
        files.forEach((file, index) => {
          const fileRow = document.createElement('tr');
          const fileNameCell = document.createElement('td');
          let fileName = file.name;

          if (disableResolutions) {
            fileName = removeResolutionsFromFileName(fileName);
          }

          if (disableExtensions) {
            fileName = removeExtensionsFromFileName(fileName);
          }

          if (replaceDots) {
            fileName = replaceDotsWithSpaces(fileName);
          }

          if (curtailLongTitles) {
            fileName = curtailFileName(fileName);
          }

          fileNameCell.textContent = fileName;
          const runtimeCell = document.createElement('td');
          const bitrateCell = document.createElement('td');
          const modifiedDateCell = document.createElement('td');
          
          // Set initial values
          runtimeCell.textContent = 'Loading...';
          bitrateCell.textContent = 'Loading...';
          modifiedDateCell.textContent = formatDate(file.lastModified);

          fileRow.appendChild(fileNameCell);
          fileRow.appendChild(runtimeCell);
          fileRow.appendChild(bitrateCell);
          fileRow.appendChild(modifiedDateCell);
          
          // Add click handler for video preview
          fileRow.addEventListener('click', function() {
            selectVideoForPreview(file, fileRow, fileName);
          });
          
          // Store file reference in the row for easy access
          fileRow._fileData = file;
          fileRow._fileName = fileName;
          
          tableBody.appendChild(fileRow);
          
          // Process video metadata asynchronously
          getVideoMetadata(file, runtimeCell, bitrateCell).then(() => {
            processedCount++;
            if (processedCount === totalFiles) {
              // Remove loading row when all files are processed
              if (tableBody.contains(loadingRow)) {
                tableBody.removeChild(loadingRow);
              }
              // Add export buttons after all files are processed
              addExportButtons();
            }
          });
        });
      });
    }

    // Handle video selection for preview
    function selectVideoForPreview(file, row, displayName) {
      // Remove selection from previously selected row
      if (currentSelectedRow) {
        currentSelectedRow.classList.remove('selected');
      }
      
      // Add selection to current row
      row.classList.add('selected');
      currentSelectedRow = row;
      
      // Update current preview file
      currentPreviewFile = file;
      
      // Show video preview
      showVideoPreview(file, displayName);
    }

    // Show video preview
    function showVideoPreview(file, displayName) {
      const previewContainer = document.getElementById('videoPreview');
      const previewTitle = document.getElementById('previewTitle');
      const previewContent = document.getElementById('previewContent');
      
      // Update title
      previewTitle.textContent = displayName;
      
      // Show container
      previewContainer.classList.add('visible');
      
      // Clear previous content
      previewContent.innerHTML = '<div class="video-preview-loading">Loading video...</div>';
      
      // Create video element
      const video = document.createElement('video');
      video.className = 'video-preview-video';
      video.controls = true;
      video.autoplay = false;
      
      // Error handling
      video.onerror = function() {
        previewContent.innerHTML = '<div class="video-preview-error">Unable to load video preview</div>';
      };
      
      // When video is ready, show it
      video.onloadedmetadata = function() {
        previewContent.innerHTML = '';
        previewContent.appendChild(video);
      };
      
      // Create object URL for the file
      const videoUrl = URL.createObjectURL(file);
      video.src = videoUrl;
      
      // Store the URL for cleanup
      video._objectUrl = videoUrl;
    }

    // Close video preview
    function closeVideoPreview() {
      const previewContainer = document.getElementById('videoPreview');
      const previewContent = document.getElementById('previewContent');
      
      // Hide container
      previewContainer.classList.remove('visible');
      
      // Clean up video element and object URL
      const video = previewContent.querySelector('video');
      if (video && video._objectUrl) {
        URL.revokeObjectURL(video._objectUrl);
      }
      
      // Clear content after animation
      setTimeout(() => {
        previewContent.innerHTML = '<div class="video-preview-loading">Loading video...</div>';
      }, 300);
      
      // Remove selection from current row
      if (currentSelectedRow) {
        currentSelectedRow.classList.remove('selected');
        currentSelectedRow = null;
      }
      
      currentPreviewFile = null;
    }

    // Add export buttons
    function addExportButtons() {
      const fileListDiv = document.getElementById('fileList');

      // Create export section
      const exportSection = document.createElement('div');
      exportSection.className = 'export-section';
      exportSection.innerHTML = '<h2 class="section-title">Export Options</h2>';

      // Create a div to hold the export buttons
      const exportGrid = document.createElement('div');
      exportGrid.className = 'export-grid';

      // Create the export buttons
      const buttons = [
        { id: 'exportPDF', text: 'Export to PDF', icon: '📄', handler: exportToPDF },
        { id: 'exportPNG', text: 'Export to PNG', icon: '🖼️', handler: exportToPNG },
        { id: 'exportText', text: 'Export to Text', icon: '📝', handler: exportToPlainText },
        { id: 'exportExcel', text: 'Export to Excel', icon: '📊', handler: exportToExcel }
      ];
      
      buttons.forEach(btn => {
        const button = document.createElement('button');
        button.id = btn.id;
        button.className = 'btn export-button';
        button.innerHTML = `<span>${btn.icon}</span>${btn.text}`;
        button.addEventListener('click', btn.handler);
        exportGrid.appendChild(button);
      });

      exportSection.appendChild(exportGrid);
      fileListDiv.appendChild(exportSection);
    }

    // Get video metadata (runtime and bitrate)
    function getVideoMetadata(file, runtimeCell, bitrateCell) {
      return new Promise((resolve) => {
        const video = document.createElement('video');
        video.preload = 'metadata';
        
        // Handle errors (file might not be a valid video)
        video.onerror = function() {
          runtimeCell.textContent = 'N/A';
          bitrateCell.textContent = 'N/A';
          resolve();
        };
        
        video.onloadedmetadata = function() {
          const seconds = video.duration;
          
          // Handle invalid duration (NaN or Infinity)
          if (!isFinite(seconds) || isNaN(seconds)) {
            runtimeCell.textContent = 'N/A';
            bitrateCell.textContent = 'N/A';
            resolve();
            return;
          }
          
          const hours = Math.floor(seconds / 3600);
          const minutes = Math.floor((seconds % 3600) / 60);
          const formattedSeconds = Math.floor(seconds % 60);

          const runtime = `${pad(hours, 2)}:${pad(minutes, 2)}:${pad(formattedSeconds, 2)}`;

          const bitrate = calculateBitrate(file, seconds);

          runtimeCell.textContent = runtime;
          bitrateCell.textContent = bitrate;
          resolve();
        };
        
        // Set a timeout in case metadata loading takes too long
        setTimeout(() => {
          if (runtimeCell.textContent === 'Loading...') {
            runtimeCell.textContent = 'N/A';
            bitrateCell.textContent = 'N/A';
            resolve();
          }
        }, 5000);
        
        video.src = URL.createObjectURL(file);
      });
    }

    // Calculate bitrate based on file size and duration
    function calculateBitrate(file, duration) {
      if (!duration || duration <= 0) return 'N/A';
      
      const fileSize = file.size;
      const bits = fileSize * 8;
      const megabits = bits / (1024 * 1024);
      const bitrate = megabits / duration;
      return bitrate.toFixed(2);
    }

    // Format date from timestamp
    function formatDate(timestamp) {
      const date = new Date(timestamp);
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    // Export to PDF
    function exportToPDF() {
      const table = document.querySelector('table');
      
      // Create a printable version with styling
      const printContent = `
        <html>
        <head>
          <title>Video Library Report</title>
          <style>
            body {
              font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
              margin: 0;
              padding: 40px;
              background: white;
              color: #1a1a1a;
            }
            h1 {
              text-align: center;
              margin-bottom: 40px;
              font-weight: 400;
              color: #059669;
            }
            table {
              width: 100%;
              border-collapse: collapse;
              margin-bottom: 40px;
            }
            th {
              background-color: #f9fafb;
              padding: 12px 16px;
              text-align: left;
              font-weight: 500;
              color: #374151;
              border-bottom: 1px solid #e5e7eb;
            }
            td {
              padding: 12px 16px;
              border-bottom: 1px solid #f3f4f6;
            }
            .folder-header {
              background-color: #059669 !important;
              color: white !important;
              font-weight: 500;
            }
            .footer {
              margin-top: 40px;
              text-align: center;
              color: #6b7280;
              font-size: 14px;
            }
          </style>
        </head>
        <body>
          <h1>Video Library Report</h1>
          ${table.outerHTML}
          <div class="footer">
            Generated on ${new Date().toLocaleDateString()} • Video Library Manager
          </div>
        </body>
        </html>
      `;

      // Create a hidden iframe for printing
      const iframe = document.createElement('iframe');
      iframe.style.display = 'none';
      document.body.appendChild(iframe);
      
      // Write content to iframe and print
      const iframeDoc = iframe.contentWindow.document;
      iframeDoc.open();
      iframeDoc.write(printContent);
      iframeDoc.close();
      
      setTimeout(() => {
        iframe.contentWindow.focus();
        iframe.contentWindow.print();
        document.body.removeChild(iframe);
      }, 500);
    }

    // Export to PNG
    function exportToPNG() {
      alert("PNG export requires the html2canvas library. For this simplified version, please use PDF export or another option.");
    }

    // Export to plain text
    function exportToPlainText() {
      const table = document.querySelector('table');
      const rows = Array.from(table.querySelectorAll('tr'));
      
      let plainTextContent = 'VIDEO LIBRARY REPORT\n';
      plainTextContent += '===================\n\n';
      
      // Process each row
      rows.forEach(row => {
        // Handle header row
        const headerCells = row.querySelectorAll('th');
        const dataCells = row.querySelectorAll('td');
        
        // If this is a folder header row
        if (row.classList.contains('folder-header')) {
          plainTextContent += `\n${dataCells[0].textContent}\n`;
          plainTextContent += '-'.repeat(dataCells[0].textContent.length) + '\n';
        }
        // If this is a regular header row
        else if (headerCells.length > 0) {
          plainTextContent += '| ';
          headerCells.forEach((cell, index) => {
            plainTextContent += cell.textContent;
            if (index !== headerCells.length - 1) {
              plainTextContent += ' | ';
            }
          });
          plainTextContent += ' |\n';
          
          // Add separator line
          plainTextContent += '| ';
          headerCells.forEach((_, index) => {
            plainTextContent += '------';
            if (index !== headerCells.length - 1) {
              plainTextContent += ' | ';
            }
          });
          plainTextContent += ' |\n';
        } 
        // If this is a data row
        else if (dataCells.length > 0) {
          plainTextContent += '| ';
          dataCells.forEach((cell, index) => {
            plainTextContent += cell.textContent;
            if (index !== dataCells.length - 1) {
              plainTextContent += ' | ';
            }
          });
          plainTextContent += ' |\n';
        }
      });

      plainTextContent += `\n\nGenerated on ${new Date().toLocaleDateString()} • Video Library Manager\n`;

      downloadFile(plainTextContent, 'video_library_report.txt', 'text/plain');
    }

    // Export to Excel (CSV)
    function exportToExcel() {
      const table = document.querySelector('table');
      const rows = Array.from(table.querySelectorAll('tr'));
      
      let csvContent = '';
      
      // Process each row
      rows.forEach(row => {
        const headerCells = row.querySelectorAll('th');
        const dataCells = row.querySelectorAll('td');
        
        // Handle folder header rows
        if (row.classList.contains('folder-header')) {
          csvContent += `\n"${dataCells[0].textContent}"\n`;
          csvContent += ',,,,\n'; // Empty row for separation
          return;
        }
        
        // Get all cells (header or data)
        const cells = headerCells.length > 0 ? headerCells : dataCells;
        
        const rowContent = Array.from(cells).map(cell => {
          // Escape quotes and wrap in quotes if contains comma
          let content = cell.textContent;
          if (content.includes('"')) {
            content = content.replace(/"/g, '""');
          }
          if (content.includes(',')) {
            content = `"${content}"`;
          }
          return content;
        }).join(',');
        
        csvContent += rowContent + '\n';
      });

      downloadFile(csvContent, 'video_library_report.csv', 'text/csv');
    }

    // Helper function to download a file
    function downloadFile(content, fileName, mimeType) {
      const blob = new Blob([content], { type: mimeType });
      const url = URL.createObjectURL(blob);
      
      const a = document.createElement('a');
      a.href = url;
      a.download = fileName;
      document.body.appendChild(a);
      a.click();
      
      setTimeout(() => {
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }, 100);
    }

    // Toggle functionality for options
    function toggleDisableResolutions() {
      disableResolutions = !disableResolutions;
      if (fileList.length > 0) createFileList();
    }

    function toggleDisableExtensions() {
      disableExtensions = !disableExtensions;
      if (fileList.length > 0) createFileList();
    }

    function toggleReplaceDots() {
      replaceDots = !replaceDots;
      if (fileList.length > 0) createFileList();
    }

    function toggleCurtailLongTitles() {
      curtailLongTitles = !curtailLongTitles;
      if (fileList.length > 0) createFileList();
    }

    // Utility functions for file name processing
    function removeResolutionsFromFileName(fileName) {
      const resolutions = ['4k', '2160p', '1080p', '720p', '480p', '480p-1080p', '8k', 'UHD', 'HD'];
      resolutions.forEach(resolution => {
        // Handle cases with spaces before/after and with/without brackets
        fileName = fileName.replace(new RegExp(`\\s*\\(?${resolution}\\)?\\s*`, 'gi'), ' ');
      });
      return fileName.trim();
    }

    function removeExtensionsFromFileName(fileName) {
      const extensions = ['.mp4', '.wmv', '.mkv', '.mov', '.mpeg', '.mpg', '.webm', '.ogv', '.f4v', '.flv', '.avi', '.m4p', '.MTS', '.M2TS', '.TS', '.m4v'];
      extensions.forEach(extension => {
        fileName = fileName.replace(new RegExp(extension + '$', 'gi'), '');
      });
      return fileName.trim();
    }

    function replaceDotsWithSpaces(fileName) {
      return fileName.replace(/\.+/g, ' ');
    }

    function curtailFileName(fileName) {
      const maxCharacters = 90;
      if (fileName.length > maxCharacters) {
        fileName = fileName.substring(0, maxCharacters - 3) + '...';
      }
      return fileName;
    }

    // Helper function to pad numbers with leading zeros
    function pad(num, size) {
      let padded = String(num);
      while (padded.length < size) {
        padded = '0' + padded;
      }
      return padded;
    }
  </script>
</body>
</html>
